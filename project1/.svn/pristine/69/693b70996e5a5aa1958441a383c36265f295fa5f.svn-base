<%@page import="member.MemberDTO"%>
<%@page import="question.QuestionDAO"%>
<%@page import="question.QuestionDTO"%>
<%@page import="java.util.List"%>
<%@page import="java.util.Date"%>
<%@page import="java.text.SimpleDateFormat"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%
	//입력된 검색 대상과 검색 키워드를 반환받아 저장
	String search=request.getParameter("search");
	if(search==null) search="";
	String keyword=request.getParameter("keyword");
	if(keyword==null) keyword="";
	
	//전달된 페이지 번호를 반환받아 저장
	int pageNum=1;
	if(request.getParameter("pageNum")!=null){
		pageNum=Integer.parseInt(request.getParameter("pageNum"));
	}

	//페이지에 응답될 게시글의 갯수 설정
	int pageSize=10;//응답 게시글의 갯수를 저장하기 위한 변수
	
	//questiontable 테이블에 저장된 전체 게시글의 갯수를 반환하는 DAO 클래스의 메소드 호출
	int totalQuestion=QuestionDAO.getDAO().getQuestionTotal(search, keyword);
	
	//총 페이지 갯수를 계산하여 저장
	int totalPage=(int)Math.ceil((double)totalQuestion/pageSize);
	
	//전달받은 페이지 번호에 대한 유효성 검사
	if(pageNum<=0 || pageNum>totalPage) {
		//비정상적인 페이지 번호가 전달된 경우 무조건 1 페이지로 설정 
		pageNum=1;
	}
	
	//페이지 번호에 대한 게시글 시작 행번호를 계산하여 저장
	// => 1 Page : 1, 2 Page : 11, 3 Page : 21, 4 Page : 31,... 
	int startRow=(pageNum-1)*pageSize+1;
		
	//페이지 번호에 대한 게시글 종료 행번호를 계산하여 저장
	// => 1 Page : 10, 2 Page : 20, 3 Page : 30, 4 Page : 41,... 
	int endRow=pageNum*pageSize;
		
	//마지막 페이지의 게시글 종료 행번호를 게시글 전체 갯수로 변경
	if(endRow>totalQuestion) {
			endRow=totalQuestion;
		}

	//시작 행번호와 종료 행번호를 전달하여 BOARD 테이블에서 페이지에 
		//응답될 게시글 목록을 검색하여 반환하는 DAO 클래스의 메소드 호출
		List<QuestionDTO> questionList=QuestionDAO.getDAO().getpageList(startRow, endRow, search, keyword);
		
		//페이지에 응답될 게시글의 출력시작번호를 계산하여 저장
		// => 게시글이 하나 출력될 때마다 1씩 감소
		int number=totalQuestion-(pageNum-1)*pageSize;
		                    
		//세션으로 공유된 인증정보(회원정보)를 반환받아 저장
		MemberDTO loginMember=(MemberDTO)session.getAttribute("loginMember");
		
		//서버의 현재 날짜(시간)정보 저장
		String currentDate=new SimpleDateFormat("yyyy-MM-dd").format(new Date());
	

%>


<div id="content">
	<div id="header">
		<h2>문의사항 관리</h2>
	</div>
	<!-- 고객 검색 -->
	<div id="section">
		<div id="optionArea"></div>
	</div>
	<!-- 고객 목록 -->
	<div id="section">
		<div id="question_list">
			<div id="question_title">
				<h2>문의하기 목록</h2>
			</div>


			<!-- 게시글 목록 출력 -->
			<table id="list">
				<tr>
					<th width="100">번호</th>
					<th width="500">제목</th>
					<th width="100">작성자</th>
					<th width="200">작성일</th>
					<th width="200">답변관리</th>
				</tr>

				<%if(totalQuestion==0) { %>

				<tr style="text-align: center;">
					<td colspan="5">검색된 게시글이 하나도 없습니다.</td>
				</tr>
				<% }else { %>
				<%--게시글 목록 출력 --%>
				<% for(QuestionDTO question:questionList) { %>
				<tr>
					<%--글번호 --%>
					<td><%=number %></td>

					<%--제목 --%>
					<td class="title">
						<a href="<%=request.getContextPath()%>/codeforbeauty.com/shop/admin/index_admin.jsp?workgroup=content&work=question_admin_detail&num=<%=question.getNum() %>&pageNum=<%=pageNum%>&search=<%=search%>&keyword=<%=keyword%>"><%=question.getTitle()%></a>
					</td>

					<%-- 작성자 --%>
					<td><%=question.getId() %></td>

					<%-- 작성일 --%>
					<td>
						<%if(currentDate.equals(question.getDateCreated().substring(0,10))) {%>
						<%=question.getDateCreated().substring(11,19) %> <%}else{ %> <%=question.getDateCreated().substring(0,19) %>
						<%} %>
					</td>
					
					<%--답변관리 --%>
					<td>
						<button>답변</button>
						<button>삭제</button>
					</td>

				</tr>
				<% number--; %>
				<% } %>
			<% } %>

			</table>
			
			<%--페이지 번호 출력(페이징 처리) 및 하이퍼 링크 --%>
			<%
			//페이지 블럭에 출력될 페이지 번호의 갯수를 설정하여 저장
			int blockSize=5;//블럭에 출력될 페이지 번호의 갯수를 저장하기 위한 변수
		
			//페이지 블럭에 출력될 시작 페이지 번호를 계산하여 출력
			// => 1 Block(1~5) : 1, 2 Block(6~10) : 6, 3 Block(11~15) : 11, 4(16~20) Block : 16,... 
			int startPage=(pageNum-1)/blockSize*blockSize+1;//블럭에 출력될 페이지 시작 페이지번호를 저장하기 위한 변수
		
			//페이지 블럭에 출력될 마지막 페이지 번호를 계산하여 출력
			// => 1 Block(1~5) : 5, 2 Block(6~10) : 10, 3 Block(11~15) : 15, 4(16~20) Block : 20,...
			int endPage=startPage+blockSize-1;
		
			//마지막 페이지 블럭의 페이지 번호 변경
			if(endPage>totalPage) {
				endPage=totalPage;
			}
			%>
			
			<%--페이지 번호 출력 및 하이퍼 링크 --%>
			<div>
			<% if(startPage>blockSize) {%>
			<a href="<%=request.getContextPath()%>/codeforbeauty.com/shop/admin/index_admin.jsp?workgroup=content&work=question_admin&pageNum=1&search=<%=search %>&keyword=<%=keyword %>">[처음]</a>
			<a href="<%=request.getContextPath()%>/codeforbeauty.com/shop/admin/index_admin.jsp?workgroup=content&work=question_admin&pageNum=<%=startPage-blockSize%>&search=<%=search%>&keyword=<%=keyword%>">[이전]</a>
			<%}else{ %>
			[처음][이전]
			<%} %>
			
			<%for(int i=startPage;i<=endPage;i++){ %>
				<%if(pageNum!=i) { %>
				 <a href="<%=request.getContextPath()%>/codeforbeauty.com/shop/admin/index_admin.jsp?workgroup=content&work=question_admin&pageNum=<%=i%>&search=<%=search%>&keyword=<%=keyword%>">[<%=i %>]</a>
				<%}else{ %>
				<span style="font-weight: bold; color: red;">[<%=i%>]</span>
				<%} %>
			<%} %>
				
			<%if(endPage!=totalPage){ %>
			<a href="<%=request.getContextPath()%>/codeforbeauty.com/shop/admin/index_admin.jsp?workgroup=content&work=question_admin&pageNum=<%=startPage+blockSize%>&search=<%=search%>&keyword=<%=keyword%>">[다음]</a>	
			<a href="<%=request.getContextPath()%>/codeforbeauty.com/shop/admin/index_admin.jsp?workgroup=content&work=question_admin&pageNum=<%=totalPage%>&search=<%=search%>&keyword=<%=keyword%>">[마지막]</a>
			<% } else { %>
			[다음][마지막]
			<% } %>
			</div>
			
			
		</div>
	</div>

</div>